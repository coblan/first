<!DOCTYPE html>
<html lang="zh-CN" ng-app="share">

	<head>
		<meta charset='utf-8' />
		<script src="http://cdn.bootcss.com/jquery/1.11.3/jquery.min.js"></script>
		<script src="http://cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
        <link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css">
<script type="text/javascript" src="http://apps.bdimg.com/libs/vue/1.0.14/vue.js"></script>
<script type="text/javascript" src="/static/js/ws4redis.js"></script>
	<script type="text/javascript">
		
	jQuery(document).ready(function($) {
    var ws4redis = WS4Redis({
        uri: 'ws://{{site_url}}/ws/talk?subscribe-broadcast&publish-broadcast&echo',
        //connecting: on_connecting,
        connected: on_connected,
        receive_message: receiveMessage,
        disconnected: on_disconnected,
        heartbeat_msg: '--heartbeat--',
    });

    // attach this function to an event handler on your site
    //function sendMessage() {
    //    ws4redis.send_message('A message');
    //}

    //function on_connecting() {
    //    alert('Websocket is connecting...');
    //     vm.status='connecting...'
    //}

    function on_connected() {
        //ws4redis.send_message('Hello');
        vm.status='connected'
    }

    function on_disconnected(evt) {
        //alert('Websocket was disconnected: ' + JSON.stringify(evt));
        vm.status='disconnected'
    }

    // receive a message though the websocket from the server
    is_first_msg=true
    function receiveMessage(msg) {
	    if(!is_first_msg){
		    vm.msgs.push(JSON.parse(msg) )
		    Vue.nextTick(function () {
		    	$('#msg_div').scrollTop($("#msg_div")[0].scrollHeight)
		    })
	    }else{
		    is_first_msg=false
	    }
	     
        //alert('Message from Websocket: ' + msg);
    }
});

		//var ws = new WebSocket('ws://{{site_url}}/ws/talk?subscribe-broadcast&publish-broadcast&echo');
		//ws.onopen = function() {
		//    console.log("websocket connected");
		//    vm.status='connected'
		//};
		//first = true;
		//ws.onmessage = function(e) {
		//    //console.log("Received: " + e.data);
		    
		//    if(e.data!='--heartbeat--' && !first){
		//	     vm.msgs.push(JSON.parse(e.data) )
		//    }
		//   	first=false
		//   	//if(e.data=='--heartbeat--'){
		//	   //	ws.send(e.data);
		//   	//}
		//};
		//ws.onerror = function(e) {
		//    console.error(e);
		//};
		//ws.onclose = function(e) {
		//    console.log("connection closed");
		//    vm.status='connection closed'
		//}
		//function send_message(msg) {
		//    ws.send(msg);
		//}
	</script>

	<script type="text/javascript">
		$(function () {
			vm=new Vue({
				el:'#talk',
				data:{
					msgs:[],
					crt_msg:'',
					name:'your name',
					status:'',
				},
				methods:{
					send:function () {
						$.post('',JSON.stringify({name:this.name,content:this.crt_msg}))
						//this.msgs.push(msg)
						this.crt_msg=''
					}
				}
			})
		})
	
	</script>
	<style type="text/css" media="screen" id="test">
		#talk{
			width:600px;
		}
		#msg_div{
			height:400px;
			overflow: auto;
		}
		.small_input{
			width:300px;
			display: inline-block;
		}
	</style>
	</head>
	<body>
		<div id="talk" class="test">
			<div id='msg_div'>
			<ul>
				<li v-for='msg in msgs' track-by="$index">
					<b v-text='msg.name'></b>
					<div><span class="test" v-text='msg.content'></span></div>
					
				</li>
			</ul>
		</div>

		<div>
			
		</div>
		<label for="yourname">名字</label>
		<input type="text" id="yourname" v-model='name' class="form-control small_input"/><br>
		<label for="content">内容</label>
		<input class="form-control small_input" type="text" id="content"  v-model='crt_msg'/>
		<button name="test" type="button"  @click='send()' class="btn btn-success">send message</button><br>
		<label >状态</label>
		<span v-text='status'></span>
		</div>
	
	</body>
</html>